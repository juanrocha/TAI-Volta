---
title: "Mapping Social Ecological Systems Archetypes"
author: "Juan Rocha, Katja Malmborg, Line Gordon, Kate Brauman and Fabrice DeClerk"
date: "`r Sys.Date()`"
output:
  pdf_document:
    citation_package: natbib
    toc: no
    toc_depth: 2
  html_document:
    toc: yes
    toc_depth: '2'
  word_document: null
fontsize: 11pt
cls: pnastwo.cls
bibliography: MappingSES_bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = "hide", dev = 'png', dpi = 600)

# knitr::opts_knit$set(progress = FALSE, verbose = FALSE)

rm(list = ls())
set.seed(12345)
# this file combines code from the 161027 draft and the simplified version of the analysis

## load libraries
library  ('gdata')
library ('readxl')
library ('dplyr')
library ('tidyr')
library ('reshape')
library (corrgram)
library (ggplot2)
# library(GGally)

# load libraries for mapping
library(maptools)
library(rgeos)
library(RColorBrewer)

# load libraries for clustering
library (vegan)
# library(rgl)
# library(cluster)
library(NbClust)
library(clValid)
# library(MASS)
# library(kohonen)
# library(factoextra)

# setwd('~/Documents/Projects/TAI/scripts/TAI-Volta')


```

### Abstract
Achieving sustainable development goals requires targeting and monitoring sustainable solutions tailored to different social and ecological contexts. Elinor Ostrom stressed that there is no panaceas or universal solutions to environmental problems, and developed a social-ecological systems' (SES) framework -a nested multi tier set of variables- to help diagnose problems, identify complex interactions, and solutions tailored to each SES arena. However, to our knowledge, the SES framework has only been applied to over a hundred cases, and typically reflect the analysis of local case studies with relatively small coverage in space and time. While case studies are context rich and necessary, their conclusions might not reach policy making instances. Here we develop a data driven method for upscaling Ostrom's SES framework and applied to a context where we expect data is scarce, incomplete, but also where sustainable solutions are badly needed. The purpose of upscaling the framework is to create a tool that facilitates decision making on data scarce environments such as developing countries. We mapped SES by applying the SES framework to poverty alleviation and food security issues in the Volta River basin in Ghana and Burkina Faso. We found archetypical configurations of SES in space given data availability, we study their change over time, and discuss where agricultural innovations such as water reservoirs might have a stronger impact at increasing food security and therefore alleviating poverty and hunger. We conclude outlining how the method can be used in other SES comparative studies.

## Introduction
Zero hunger and no poverty are the first two sustainable development goals [@Assembly:2015th; @Lubchenco:2015eb]. Together with clean water and sanitation, they conform the most basic needs of human beings. Understanding how societies and ecosystems self-organize to provide these goods and services, to meet these basic needs, is a core challenge of sustainability science. Countries around the world have agreed on pursuing 17 sustainable development goals. Achieving them, however, requires targeting and monitoring solutions that fit each different social-ecological context [@Griggs:2013cm]. These countries need to meet this challenge by understanding the diversity and dynamics of social and ecological characteristics of their territories. But data to meet these demands are not always available or even collected, and methods development for data scarce developing countries is imperative. There is a need for mapping social-ecological systems (SES) to better understand their differences, context dependent attributes, and most importantly the generalizability of sustainable solutions.

Nobel prize winner Elinor Ostrom advocated embracing social-ecological complexity. Ostrom recognized that there is no universal solution to problems of destruction of overuse of natural resources [@Ostrom:2007je] and further developed a Social-Ecological Systems' (SES) framework hoping that it will helps us accumulate knowledge and better understanding of what works and what does not in different SES arenas [@Ostrom:2009p6785]. The SES framework is a nested multi tier set of variables that has been suggested as features that characterize distinctive aspects of SES. The SES framework has been typically applied to local case studies that cover relatively small areas and short periods of time (documented in two publicly available datasets: the [SES Library](https://seslibrary.asu.edu)  and the [SES Meta Analysis Database](https://sesmad.dartmouth.edu)). Over a hundred case studies have been coded in these databases, however the scale at which they are coded make it hard to bring their lessons to policy making relevant arenas.

The purpose of this paper is to develop a data driven method to upscale Ostrom's SES framework. It is targeted to developing countries, where available data is restricted in quality and monitoring programs might not be on place. As a working example we studied the Volta River basin, a cross national watershed that covers roughly two thirds of Burkina Faso's and Ghana's joint territories. The West African Sahel is a highly vulnerable area due to wide-spread of poverty, recurrent droughts and dry spells, political upheaval, emergent diseases (e.g. ebola), rapid urbanization, and growing food demand [@Lambin:2014eg]. The region offers a sharp gradient in climate, humidity, as well as a strong gradient of economic development, from the relatively rich Ghanaian urban regions in the south to the poor regions of northern Burkina Faso dominated by smallholder agriculture and pastoral systems. In particular, we will look at how the construction of water reservoirs might have an impact on food security, a key sustainable development goal. The following section outlines how we operationalize the Ostrom's SES framework to the scale of the Volta River basin based on publicly available data and national statistics. Next we describe the SES archetypes found, how they change over time and how reservoir development explain the trends. We then discuss the overall results and the applicability of our methods to other developing context.

## Method summary: mapping SES archetypes
Identifying SES archetypes from data is in essence a clustering problem. A plethora of methods exist to perform clustering analysis, but before explaining the details of our choices, first we present a brief review of what others have done when trying to characterize SES.

The idea that SES are intertwined and interdependent systems is not new: SES are human and natural coupled systems where people interact with natural components; they often exhibit nonlinear dynamics, reciprocal feedback loops, time lags, heterogeneity and resilience [@Liu:2007dq]. It has been suggested that complex adaptive systems, such as SES, should leave statistical signatures on social and ecological data that allows pattern identification of typologies and makes possible to follow their spatial patterns as well as trajectories through time [@Holland:2012ur; @Levin:2000vk]. Earlier efforts to map SES have been more general in purpose, and global in scale, such as the attempt to identify Anthromes (“human biomes”) [@Ellis:2010p6408; @Ellis:2008p314], or general land system archetypes [@SurendranNair:2016tz; @Vaclavik:2013cs; @Ropero:2015bp]. Reflecting on global consequences of land use, Foley _et al._ [-@Foley:2005p190] proposed a conceptual framework for bundles of ecosystem services, the idea that landscape units can be classified by the sets of goods and services that a SES co-produces, or more generally, a set of social-ecological interactions. The idea of mapping bundles of ecosystem services has gained empirical support with studies that range from the watershed to national scales in Canada [@RaudseppHearne:2010p5327; @Renard:2015ew], Sweden [@Meacham:2016cy; @Queiroz:2015cv], Germany [@Rabe:2016hp], and South Africa [@Hamann:2015cx]. Similar ordination methods has also been used to study regime shifts from foraging to farming societies in ancient SES [@Ullah:2015eb].

Despite the differences in purpose, scale, resolution and datasets used, what the aforementioned studies have in common is that they attempt to map SES by combining multivariate methods of ordination and clustering algorithms to find out i) systems' typologies and ii) potential underlying variables of change. Here we follow a similar rationale but using Ostrom's SES framework. In Ostrom's parlance a SES has 6 key subsystems: i) resource units (RU), resource system (RS), governance system (GS), users (U), interactions (I) and outcomes (O); all framed by social, economic and political settings (S) as well as by related ecosystems (ECO). Each of these subsystems have a nested second tier of variables (53 in total) aimed to capture key features of the first tier [@Ostrom:2009p6785]. We collected publicly available datasets that matched as proxies of any of the Ostrom's variables but at the second administrative level for Ghana and Burkina Faso, namely districts and provinces respectively.

### Data

Since our analysis focus on food security issues the defining key interaction (I) of our SES characterization is crop production. It is a dummy variable that reflect both the capacity of the ecosystem to provide food services, but also the human labor and preferences necessary as input to co-produce the service. Crop data, both production and cropped area, were collected from national statistical bureaux. While data does exist for 32 crops from 1993-2012, here we only used 7 crops with minimum missing values, and the last 7 year averages to correct for outliers (See SM for crop selection). Users (U) and their social, economical and political settings (S) were here characterized by national census statistics and their change over the period 1996-2006 for Burkina Faso and 2000-2010 for Ghana. The ecological system (ECO) is characterized by biophysical variables from CRU [_Katja clarify here_] that summarizes aridity, mean temperature, precipitation and slope. The resource system (RS) is a combination of variables that facilitate or not agriculture (our key interaction) such as the percentage of area dedicated to crops, presence of water reservoirs, or the variance of kcals produced as a proxy of predictability. Resource units (RU) were characterized by cattle per capita, since it is a source of insurance for farmers in the area. All data is standardized to the range 0:1 and log transformed for distributions with heavy tails. Table 1 summarizes the framework and the proxies used.

Table 1. Summary variables used and their equivalence with the Ostrom's SES framework.

| 1st tier     |2nd tier     | Indicators       | Comments                      |
|--------------|-------------|------------------|-------------------------------|
|Socio-economic and political settings (S) | S2-Demographic trends | Population trend  | Change in population density (most recent census / previous cencus)|
| | | Inter regional migration | % people registered in a province or district who were born in different region of registration |
| | | Intra regional migration | % people registered in a province or district who were born in another district within the same region |
| | S5-Market Incentives | Market access | Median of market access index [@Verburg:2011jb] |
|Resource System (RS)|RS4-Human constructed facilities | Dams | one of the most common agricultural innovations in the area as insurance against drought, water source for cattle and irrigation source for crops |
| | RS7-Predictability of system's dynamics| variance of production | Measured in kcals, is a proxy of how stochastic crop production is related to food security|
|Resource Units (RU)| RU5-Number of units| Cattle per $km^2$ | Cattle is an insurance for farmers in the area and also related to resource mobility (RU1)|
| | | Small ruminants per capita | Small ruminants are also source of insurance |
| Users (U) | U1-Number of users | Population density | Measured in persons per $km^2$ |
| | | Ratio of farmers | % people of adult population whose main occupation is agriculture |
| | U2-Socioeconomic attributes | Ratio of children | %% children age 0-14 out of total population |
| |  | Ratio of woman | % women out of total population |
| |  | Literacy | % of adult population who are literate |
|Related Ecosystems (ECO)|ECO1-Climate patterns | Aridity | Mean aridity gradient|
| | | Mean temperature | Annual mean temperature in C |
| |ECO3-Flows | Soil water |Median soil water holding capacity in mm (based on soil data) |
| | | Wet season | Number of months with precipitation > 60 mm |
| | | Slope 75 | 75th percentile slope in province/district |
|Interactions (I)| I1-Harvesting levels | Kilo caloires for diverse crops | Cowpea, maize, millet, rice, sorghum, soy and yam |



### Clustering SES archetypes

To test the optimal number of clusters, 30 different indexes were compared following the protocol described by Charrad et al [-@Charrad:2014tp]. We further test the internal validation and stability validation of 9 different clustering techniques: hierarchical clustering, self-organizing maps, k-means, partitioning around medoids _pam_, divisible hierarchical algorithm _diana_,  a sampling based clustering _clara_, a fuzzy clustering _fanny_, self-organizing trees _sota_, and model-based algorithm [@Brock:2008vz]. While the first technique offers a robust estimation of the number of clusters in the data, the second helps choosing an optimal clustering algorithm. Results are typically presented as non-metric multi dimensional ordinations and their spacial distribution in maps of the Volta basin. The maximum dissimilarity distance was used to maximize the distance between components, while the Ward aggregation method was used to minimize the total within-cluster variance [@Charrad:2014tp]. For visualizations we used a less restrictive Manhattan distance to ensure convergence. We further investigate the interdependences between Ostrom's nested variables, by reiterating the ordination on a set of variables of interest (e.g. interactions [I]) and performing vector fitting with the remaining variable sets (e.g. resource (RU and RS), social (U and S), ecological (ECO)).


[_Double check: Temporal trends were explored only on the interaction dataset. - I might change this and do it also in cultivated area that is not part anymore of the interaction dataset._]

>* Maybe insert here another subheading explaining the temporal analysis.

```{r data, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, results = 'hide'}

##### Useful functions for later:
### Select only districts on the Volta Basin
volta.only <- function(x){
  x <- x [ is.element (x$TAI_ID1, volta.shp@data$TAI_ID1 ), ]
  x <- droplevels(x)
}

### Normalizing by scaling everything to 0:1
rescale_hw <- function (x){ # This is Hadley Wickman function from his book R for DataScience
  rng <- range(x, na.rm= TRUE, finite = TRUE)
  (x - rng[1]) / (rng[2] - rng[1])
}

### Correct the numeric format from excel files
correct.num <- function (x){
  l <- length(x)
  x[3:l] <- apply (x[3:l], 2, function (x){as.numeric(x)} )
  return(x)
}

## Update this with new importing data code
setwd("~/Documents/Projects/TAI/TransformedData/Data_Burkina&Ganha")
# load map for visualizations and data
volta.shp <- readShapeSpatial("~/Documents/Projects/TAI/TransformedData/Bundling/Volta_bundling1.shp", proj4string = CRS('+init=epsg:4378'))

# plot(volta.shp)
# invisible(text(getSpPPolygonsLabptSlots(volta.shp),
#  labels=as.character(volta.shp@data$ADM_2), cex=0.4))

## Read data
load('~/Documents/Projects/TAI/TransformedData/Data_Burkina&Ganha/161205_Volta.RData')

#### kcals and dams data
dams <- read_excel(path = 'Volta_Dam_density_KLC.xlsx', sheet = 1)
kcals <- read_excel("crop_kcals.xlsx", sheet = 1)


## Select only volta places
dat <- dat %>% volta.only()

### SES variables for later
#### New file with raw values from Katja: 160901
file <- 'Volta_Vars_raw_160901.xlsx'
sn <- sheetNames(xls=file)


dams$TAI_ID2 <- as.factor(dams$TAI_ID1)
# dat <- left_join(dat, dams, by = c("ADM_2", "TAI_ID2"))

users <- read.xls(file, sheet=2, dec=',')
users <- correct.num(users)
users$TAI_ID1 <- as.factor(users$TAI_ID1)
resource <- read.xls (file, sheet=3, dec=',')
biophys <- resource [c(1,2,11:15)]
resource <- resource [-c(11:15)]
biophys <- correct.num(biophys)
resource <- correct.num(resource)
resource$TAI_ID1 <- as.factor(resource$TAI_ID1)
resource <- left_join(resource, dplyr::select(dams, TAI_ID2, Dams), by = c("TAI_ID1" = "TAI_ID2"))

biophys$TAI_ID1 <- as.factor(biophys$TAI_ID1)
biophys$Aridity <- 1-biophys$Aridity  # Invert the scale so results are easy to interpret.
resource <- resource[-c(9)] #delete dams density


social <- dplyr::select(users, TAI_ID1, External_migration, Regional_migration, Pop_trend)
social <- left_join(social, dplyr::select(resource, TAI_ID1,Market_access), by = "TAI_ID1")
users <- dplyr::select(users, TAI_ID1, Farmers, Urbanization, Literacy, Pop_dens_log, Ratio_children, Ratio_women)
eco <- dplyr::select(biophys, TAI_ID1, Aridity, Mean_temp, Soil_water, Wet_season, Slope75)
res.units <- dplyr::select(resource, TAI_ID1, Cattle_sqkm, Small_ruminant_capita)
res.syst <- dplyr::select(resource, TAI_ID1, Dams)

```

## Results

```{r interaction, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, results = 'hide'}

## only 7 key crops, | crop == 'Cocoyam'| crop == 'Cassava'| crop == 'Ground nuts'
datKeyCrops <- (filter(dat, crop == 'Maize' | crop == 'Millet'| crop == 'Rice'| crop == 'Yam'| crop == 'Sorghum'| crop == 'Cowpea'| crop == 'Soy'  ))

datKeyCrops <- drop.levels(datKeyCrops)

## only years with most complete information (3% NA)
datKeyCrops <- (filter(datKeyCrops, Year > 2001, Year < 2010, Year !=2006))

datKeyCrops$TAI_ID2 <- datKeyCrops$TAI_ID1

## Crop dat is now dat from the ExtracDataTAI file
crop.dat <- datKeyCrops

### The imputation doesn't work because we miss crops in a whole country!! So there is no data to inpute, e.g. Cassava
# crops.impute <- list()
#
# for (i in 1:10) { # 10 crops
#   df1 <- dplyr::filter(crop.dat, crop == levels(crop.dat$crop)[1]) %>%
#     dplyr::select(-prod) %>%
#     tidyr::spread(key = Year, value = area) %>%
#     
# }

crop.dat$country <- ifelse(as.numeric(as.character(crop.dat$TAI_ID1)) > 3000, 'GH', 'BF')


crop.dat <- crop.dat %>%
  mutate(sq_prod = sqrt(prod), sq_area = sqrt(area)) %>%
  mutate( #dt_prod = sq_prod - mean(sq_prod), Los detrending tienen que calcularse en el agregado de cada TAI_ID1, no para todos los datos!!!
    # dt_area = sq_area - mean(sq_area),
    log_prod = log1p(prod),
    yield = ifelse(prod == 0 | area == 0, 0, prod/area),
    log_yield = log1p(yield),
    log_area = log1p(area) #,
    # Variance needs to be calculated across years!!!
    # var_yield = var(yield, na.rm = T),
    # var_prod = var(prod, na.rm = T),
    # var_area = var(area, na.rm = T)
  )

# variance needs to be calculated over time

tot.area <- crop.dat %>%
  dplyr::select (TAI_ID2, crop, area, Year) %>%
  group_by ( TAI_ID2, Year) %>%
  summarize (tot_area = sum(area, na.rm = TRUE))

crop.dat <- left_join(crop.dat, tot.area, by = c("TAI_ID2", 'Year'))
crop.dat <- crop.dat %>%
  mutate(prop_cultivated_area = area / tot_area )


### Calculate the 7 year mean
crop.area <- crop.dat %>%
  dplyr::select(TAI_ID2, crop, prop_cultivated_area, Year) %>%
  group_by(TAI_ID2, crop) %>%
  summarize(mean_area = var(prop_cultivated_area, na.rm= TRUE))

## remember we are using log-transformed area

## Now do the same for kcals

# kcals
crops.nam <- tolower(levels(crop.dat$crop))
# crops.nam[2] <- 'taro' # cocoyam is aka. taro
crops.nam[6] <- 'soybean'
# crops.nam[4] <- "groundnut"
crops.nam %in% kcals$CROPNAME

cals.fao <- filter(kcals, CROPNAME %in% crops.nam) %>% dplyr::select(crop = CROPNAME, kcals_fao = kcals.per.ton.fao)

cals.fao$crop <- as.factor(cals.fao$crop)
levels(cals.fao$crop) <- levels(crop.dat$crop)

crop.dat <- left_join(crop.dat, cals.fao, by = c("crop"))
crop.dat <- crop.dat %>%
  mutate(kcal_crop = (prod * kcals_fao)) # I calculate the log below in interact
# remember we are using log-transformed production.

## The commented code aggregates kcals per province regardless of crop. For paper I want crops.
# kcals <- crop.dat %>%
#   dplyr::select(TAI_ID2, crop, kcal_crop, Year) %>%
#   group_by(TAI_ID2, crop) %>%
#   summarize(mean_kcal_yr = mean(kcal_crop, na.rm= TRUE)) %>%
#   group_by(TAI_ID2) %>%
#   summarize(kcals = sum(mean_kcal_yr, na.rm = TRUE))

kcals <- crop.dat %>%
  dplyr::select(TAI_ID2, crop, kcal_crop, Year) %>%
  group_by(TAI_ID2, crop) %>%
  summarize(mean_kcal = mean(kcal_crop, na.rm= TRUE))

### Now you need the raw data of population in order to calculate per capita values
popG <- read_excel('~/Documents/Projects/TAI/TransformedData/Data_Burkina&Ganha/GH_Population_2010_TAI_ID.xlsx', sheet = 1)
popG <- popG[!is.na(popG$Region),]
# str(popG)
popB <- read_excel('~/Documents/Projects/TAI/TransformedData/Data_Burkina&Ganha/BF_CountrySTAT_social.xlsx', sheet = 1)
popB <- popB[!is.na(popB$Total),]
# str(popB)

popG <- dplyr::select(popG, TAI_ID1, Total)
popB <- dplyr::select(popB, TAI_ID1, Total)

pop <- bind_rows(popG, popB) %>%
  volta.only()

rm(popG, popB)

pop <- dplyr::select(pop, TAI_ID2 = TAI_ID1, population = Total)
pop$TAI_ID2 <- as.factor(pop$TAI_ID2)

dat.int <- left_join( pop, kcals, by = 'TAI_ID2')
dat.int <- mutate(dat.int, kcal_cap = (mean_kcal / population) )


# #interaction dataset: select the mean for kcals (log)
interact <- dplyr::select(dat.int, TAI_ID2, crop, mean_kcal) %>%
  tidyr::spread(key = crop, value = mean_kcal) %>%
  dplyr::transmute(TAI_ID1 = TAI_ID2, m_cowpea = log1p(Cowpea), m_maize = log1p(Maize), m_millet = log1p(Millet),
                m_rice = log1p(Rice), m_sorghum = log1p(Sorghum), m_soy = log1p(Soy), m_yam = log1p(Yam))


crop.area <- dplyr::select(crop.area, TAI_ID2, crop, mean_area) %>%
  tidyr::spread( key = crop, value = mean_area) %>%
  dplyr::rename(TAI_ID1 = TAI_ID2, a_cowpea = Cowpea, a_maize = Maize, a_millet = Millet,
                a_rice = Rice, a_sorghum = Sorghum, a_soy = Soy, a_yam = Yam)

var_kcals <- crop.dat %>%
  dplyr::select(TAI_ID1, crop, kcal_crop, Year) %>%
  group_by(TAI_ID1, Year) %>%
  summarize(kcals = sum(kcal_crop, na.rm= TRUE)) %>%
  ungroup() %>% group_by(TAI_ID1) %>%
  summarize(sd_kcals = sd(kcals, na.rm = T)) #sd is on units of the original data = kcals



# dfx <- left_join(interact, crop.area)

####### To Do #######
### step missing: combine res.syst with crop_area; variance_kcals.
res.syst <- left_join(res.syst, var_kcals, by = 'TAI_ID1') #%>%
  #left_join(., crop.area)


## ggplot(crop.dat, aes (Year, prop_cultivated_area, color = TAI_ID1)) + geom_line(show.legend = F) + facet_wrap(~crop)

```

The Volta river basin has different sets of social-ecological systems. The clustering search identifies an optimal number of 6 archetypes suggested by 11 out of 30 indexes, followed by 3 clusters (4 indexes), and 9 clusters (4 indexes). The tests for internal and stability validation support groupings of 3 and 9 clusters (SM Fig 1) discussed below. By comparing different algorithms, the test also suggest that hierarchical clustering is the best performing technique with low numbers of clusters; while stability validation suggest _clara_ or _pam_ with higher number of clusters (9). Figure 1 summarizes the clustering of second level administrative units with the best performing clustering methods for 6 archetypes. All maps render very similar results, specially with _clara_, _pam_ or _k-means_ (Fig 1a:c). As expected, hierarchical clustering (Fig 1e,f) increase the overlapping of communities detected, performing better on a smaller numbers of clusters (3). Lower numbers of clusters often group all provinces of Burkina Faso on one set regardless of the algorithm used, while a higher number (9) tend to increase the groups overlap on the non-dimensional space (See SM Fig1 -same as Fig 1 but with 9 clusters). Here we favor 6 clusters as the number of archetypes given the strong support found by comparing 30 the indexes proposed [@Charrad:2014tp]. The stability validation [@Brock:2008vz] suggest higher numbers of clusters (using only 4 indexes), meaning that results are robust when systematically removing columns of the dataset -a feature desired in highly correlated data [@Brock:2008vz] (See correlations in SM Fig2).

> * Plot variance against lat / long in suplementary material. I think it's key to understand why all BF tend to be clustered in one.

```{r analysis, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, results = 'hide', fig.show= 'hide'}
####### Now merge data for clustering, it's ready!
df <- left_join(biophys, users) %>%
  left_join(., social) %>%
  left_join(., res.units) %>%
  left_join(., res.syst) %>%
  left_join(., interact)

# str(df)
#### check the distribution of variables
# X dataset for plotting final distributions in ggplot
# x <- gather(df[-c(1,2)], key = variable) # df[1] is ADM_2 the names of the provinces
# x$variable <- as.factor(x$variable)
# g <- ggplot (x, aes(value), group = x) + geom_density()
# g + facet_wrap(~variable, scales = 'free')
#
# rm(x)

### Re-scale only variables that are not already between 0:1
# Note this is non-normalized data, original values. After the following line all is "rescaled" to 0-1
df[-c(1,2)] <- apply(df[-c(1,2)], 2, rescale_hw)


############ Clustering
## Using mahalanobis distance help us dealing with colinearity or strong correlations.
d <- vegdist(df[-c(1,2)], method = "mahalanobis", tol= 10e-20)
## Validating number of clusters
## Number of clusters with NdClust: uses 30 different index and compare them to decide the optimal partition
# euclidean and manhattan are not good for gradient separation (see help vegdist)
m <- "ward.D2" # minimize the total within-cluster variance

# J170309: Shall we drop cowpeas due to high correlations?
clust_num <- NbClust( data = df[-c(1,2)], distance = 'maximum',
                      min.nc = 3, max.nc = 9, method = m, alphaBeale = 0.1, index = 'all')

# clust_num_mb <- NbClust( data = df[-c(1,2)], diss = d, distance = NULL,
#                          min.nc = 3, max.nc = 9, method = m, alphaBeale = 0.1, index = 'all')


## Stability validation
# stab <- clValid(obj=as.data.frame(df[-c(1,2)]), nClust=c(3:9),
#                 clMethods=c('hierarchical', 'kmeans', 'diana', 'fanny', 'som',
#                             'pam', 'sota', 'clara', 'model'),
#                 validation='stability')
#
# # Internal validation
# intern <- clValid(obj=as.data.frame(df[-c(1,2)]), nClust=c(3:9),
#                   clMethods=c('hierarchical', 'kmeans', 'diana', 'fanny','som',
#                               'pam', 'sota', 'clara', 'model'),
#                   validation='internal')

## Prepare the clustering result dataset
mds <- metaMDS(df[-c(1,2)], distance = 'manhattan', trymax = 1000, verbose = FALSE)

```


```{r Fig1, echo = FALSE, fig.align='center', fig.height=3, fig.width=8, error=FALSE, warning=FALSE, message=FALSE, fig.cap = 'Clustering results. Social-Ecological systems archetypes found by applying different clustering techniques. Upper panel shows non-metric multi dimensional scaling of the data and maps for 6 clusters, and the lower panel the respective maps. Best performing algorithms are hierarchical clustering (e), partition around medioids (c), and clara (a).', dev.args= list(pointsize = 7)}


########################
### Clustering all
########################
library(kohonen)
# quartz(width=8, height= 3, pointsize = 7)
# number of clusters
k <- c(6)

par(mfrow=c(2,6))

for (i in 1:length(k)){
  par(mai = c(0.2, 0.2, 0.2 , 0.2))

  ## Best selected algorithms: hierarchical, k-means and som
  fitKM <- kmeans(df[-c(1,2)], centers= k[i] ,iter.max=2000,nstart=50)
  fitSOM <- som(as.matrix(df[-c(1,2)]), grid= somgrid(3,2,'hexagonal'))
  fitPAM <-pam(df[-c(1,2)], metric='manhattan', k=k[i])
  dis <- vegdist(df[-c(1,2)], method='manhattan')
  clus <- hclust(dis, method='ward.D2')
  grp <- cutree(clus, k[i])
  fitHier <- grp
  fitClara <- clara(df[-c(1,2)], k = k[i])

  # create a clusters dataframe
  clusters <- data.frame(TAI_ID1 = df$TAI_ID1, # codes
                         Clara = as.vector(fitClara$clustering ),
                         k_means = as.vector(fitKM$cluster),
                         PAM = as.vector(fitPAM$clustering),
                         SOM = as.vector(fitSOM$unit.classif),
                         Hierarchical = as.vector(fitHier),
                         Ward = clust_num$Best.partition
  )

  # create colors
  levelCols <- brewer.pal(k [i], "Accent")

  # plot
  for (j in 2:7){
    # Plot MDS with grouping according with each clustering algorithm
    ordiplot(mds, type='none', main= paste(letters[j-1], colnames( clusters)[j],  sep = '.) '), xlab = NULL, ylab = NULL )
    points(mds$points, cex=1, lwd=1.5,
           col= levelCols[clusters[,j]]) #volta.shp@data[,i]
    ordihull(mds, groups= clusters[,j], label = TRUE, cex=0.7,
             col="purple", lty=1)
    #plot(ef1, p.max=0.05, col='blue', cex=0.5)
    #plot(ef2, p.max=0.05, col='purple', cex=0.5)
  }


  for (j in 2:7){
    par(mai = c(0.2, 0.2, 0.2 , 0.2))
    # Plot map with resulting clusters
    plot(volta.shp, col= levelCols[clusters[,j]],lwd=0.1)
    # main= paste(k[i], colnames( clusters)[j], sep = ' '))

  }
}

# plot(volta.shp, col = levelCols[clust_num_mb$Best.partition], lwd = 0.1)
# setwd("~/Documents/Projects/TAI/figures")
# quartz.save(file = '161125_full_clustering.png', type = 'png', dpi = 300,width=15, height=5, pointsize = 7 )

```

Following the analogy of bundles of ecosystem services [@Foley:2005p190; @RaudseppHearne:2010p5327], here we also map the sets of SES variables that co-variate in space using the 6 archetypes found by the clustering analysis (Figure 2). We found that the SES of the Burkina Faso share of the Volta basin is characterized by higher aridity than the rest of the basin, the kilocalories produced by crops come primarily from cowpea and sorghum (Fig 2a,b), or yam and maize in central Burkina Faso (Fig 2d). Central Burkina Faso has relatively higher wet season than the rest of the country, it counts with a better connected infrastructure to the market, and it is where regional migration and literacy occurs at its peak. Southern Burkina Faso and it's furthermost northern district (Fig 2a,b) also count with the higher ratio of woman and children, and the higher percentage of farmers, higher density of cattle and small ruminants per capita, as well as the higher concentration of water reservoirs; features that are shared with central Ghana (Fig 2b). Fig 2c shows a very productive agricultural area in Ghana where most of the crops analized are produced in relatively high ratios compared to other SES. Not surprisingly Fig 2c also have the higher proportion of farmers for Ghana. Market access and literacy is higher in Fig 2e and f, where rice and maize play important roles on the agricultural production. Fig 2f is also where the higher cattle density is reported for the basin.

```{r Fig2, echo = FALSE, fig.align='center', fig.height=4, fig.width=8, error=FALSE, warning=FALSE, message=FALSE, fig.cap = "Bundles of SES variables. The SES framework was operationalized by analysing datasets that are proxi of Ostrom's suggested variables at spatial units that correspond to the second administrative level. The clusters correspond to Fig 1c obtained with partition around medioids.", dev.args= list(pointsize = 9) }

k <- 6 # optimal number of clusters
# avg <- apply (df[-c(1,2)], 2, mean)

# dis <- vegdist(df[-c(1,2)], method='manhattan')
# clus <- hclust(dis, method='ward.D2')
# grp <- cutree(clus, k)
# fitHier <- grp

## All the fits were calculated beforehand.
# following Garry's code with k-means
# fitKM <- kmeans(df[-c(1,2)], centers= k ,iter.max=2000,nstart=50)
# fitPAM <-pam(mds$points, metric='manhattan', k = k)

df$clus <- fitPAM$clustering #grp is the option when using hierarchical

## Colors
clusColors <- c('gray90', 'gray10')
# freq <- order(fitKM$size, decreasing = TRUE)
freq <- order(fitPAM$clusinfo[,1], decreasing = TRUE)
# freq <- order(table(fitHier), decreasing = TRUE)

# colnames(fitKM$centers)
E_Cols <- colorRampPalette(c('salmon', 'purple4'), interpolate = "linear", alpha = T) #brewer.pal(length(biophys)- 2, "PuBu") # 14
U_Cols <- colorRampPalette(c('yellow', 'orange'), interpolate = "linear", alpha = T) #brewer.pal(length(users) - 2, "Reds") #10
R_Cols <- colorRampPalette(c('tan', 'olivedrab4'), interpolate = "linear", alpha = T)#brewer.pal(length(resource)- 2, "Greys") #9
I_Cols <- colorRampPalette(c('steelblue4', 'red4'), interpolate = "linear", alpha = T) #brewer.pal(length(interact)- 1, "YlGn") #5

FlowerCol <- c(E_Cols(5), U_Cols(10), R_Cols(4), I_Cols(7))

## ploting
# quartz(width=8, height = 4, pointsize = 8)
par(mfcol = c(3,6), mai = c(.02, 0.2, 0.2, 0.2))
layout(matrix(c(1,2,13,3,4,13,5,6,13,7,8,13,9,10,13,11,12,13), 3,6, byrow = F))

for ( i in 1:k) {
  varCols <- clusColors[(as.vector(fitPAM$clustering) == freq[i]) + 1]
  plot (volta.shp, col = varCols, lwd = 0.1, main= letters[i], cex.main = 1.5)

  stars (t(dplyr::filter(df[-c(1,2)], clus == i) %>% dplyr::select(-clus) %>% colMeans()), len = 0.6, full = TRUE, scale = FALSE,
         radius = TRUE, draw.segments = TRUE, col.segments = FlowerCol)
}
# legend
# par( mai = c(1,1,1,1))
# leg <- data.frame (leg= rep(1, length(df) -2 ), row.names =  colnames(df[-c(1,2)]))  # dat[-c(23)]
# stars (t(leg), len = 1, full = TRUE, scale = FALSE, key.loc = c(2.3, 2.3), locations = c(2.3, 2.3),
#        radius = TRUE, draw.segments = TRUE, col.segments = FlowerCol,
#        axes = F, plot = T, cex = 0.9)
plot(0,0, type = 'n', xlim = c(0,9), ylim=c(0,5), axes = F)
legend(x = 0, y = 5,legend = colnames(df[-c(1,2)])[1:5], fill = FlowerCol [1:5], bty = 'n' , title = 'Ecological', cex = 1)
legend(x = 2, y = 5,legend = colnames(df[-c(1,2)])[6:10], fill = FlowerCol [6:10], bty = 'n' , title = 'Users', cex = 1)
legend(x = 4, y = 5,legend = colnames(df[-c(1,2)])[11:15], fill = FlowerCol [11:15], bty = 'n' , title = 'Social', cex = 1)
legend(x = 6, y = 5,legend = colnames(df[-c(1,2)])[16:18], fill = FlowerCol [16:18], bty = 'n' , title = 'Resource', cex = 1)
legend(x = 8, y = 5,legend = colnames(df[-c(1,2)])[20:26], fill = FlowerCol [20:26], bty = 'n' , title = 'Interactions', cex = 1)

# quartz.save(file = '161125_SESarchetypes.png', type = 'png', dpi = 200,width=7, height=7, pointsize = 8 )

```

The potential relationships between different components of the Ostrom's framework were further investigated by applying vector fitting to non-metric multi-dimensional scaling (Fig 3). The ordination method applied to each set of variables reveals that the clustering (Fig 1) is highly driven by the interactions (crops) data (Fig 3 top row). The green, purple and cream clusters (Fig 1c, Fig3) tend to produce the same set of crops and rely heavily on cattle and small ruminants; and also where dams have been more used. The predictability of the resource system measured as the variance of kilocalories over 7 years of data shows that the cream and green clusters (Fig 3, Fig 2a,b) are the areas where crops are more unpredictable and where food security might be compromised, areas with the higher concentration of farmers and children. A similar ordination on the ecological variables (ECO) supports the idea that water reservoirs and cattle have been highly correlated to places where aridity is harsh, and benefit places where the agricultural portfolio is characterized by soy, cowpea, sorghum and rice. These results put together suggest that agricultural innovations related with water reservoirs development have been more successful in the central parts of Burkina Faso (Fig 2d) but further developments would likely have a strong impact on the SES represented in Fig 2a and especially Fig 2b, where social and ecological conditions are relatively similar but the standard deviation of kilocalories produced is at its maximum - indicating vulnerability on food security.

> * If including temporal analysis include main finding here.

```{r cube, include = FALSE, cache = TRUE, results = 'hide'}

knitr::opts_chunk$set(progress = FALSE, verbose = FALSE)

resource <- left_join(res.syst, res.units)
social2 <- left_join(social, users)

######################
### The cube
######################

cube <- function(s1, s2, s3, s4){ # each side of the cube is s_
  mod1 <- metaMDS(s1, distance = 'manhattan', trymax = 1000, verbose = FALSE)
  ef1 <- envfit(mod1, s2, permu=999, verbose = FALSE)
  ef2 <- envfit(mod1, s3, permu=999, verbose = FALSE)
  ef3 <- envfit(mod1, s4, permu=999, verbose = FALSE)

  # ## plot
  # plot(mod1, type='p', display='sites', cex=0.8)
  # plot(ef1, p.max=0.05, col='blue', cex=0.8)
  # plot(ef2, p.max=0.05, col='purple', cex=.8)
  # plot(ef3, p.max=0.05, col='grey', cex=.8)

  return(list(mod1, ef1, ef2, ef3))
}

int.side <- invisible(cube(s1 = interact[-c(1)], s2 = resource[-c(1)], s3= eco[-c(1)], s4 = social2[-c(1)]))
bio.side <- cube(s1 = eco[-c(1)] , s2 =  resource[-c(1)], interact[-c(1)], s4 = social2[-c(1)])
res.side <- cube(s1 =  resource[-c(1)] , s2 =  eco[-c(1)], s3= interact[-c(1)], s4 = social2[-c(1)])
soc.side <- cube(s1 = social2[-c(1)] , s2 =  resource[-c(1)], s3= interact[-c(1)], s4 =  eco[-c(1)])

```


```{r Fig3, fig.height = 4, fig.width = 4, error=FALSE, warning=FALSE, message=FALSE, fig.cap = "Relationships between SES framework components. Each subsystem in the Ostrom's framework is ordered with non-metric multidimensional scaling and vectors are fitted for all other variables that significanlty (p < 0.001) explain the variation of the ordination. Each plot title shows the dataset in which the ordination was applied versus the dataset used for the vector fitting. The colors of points and contours correspond to the archetypes found in Fig 1c.", dev.args= list(pointsize = 6) }

# create colors
levelCols <- brewer.pal(k, "Accent") # check for better colours with alpha, k = 7

## an especial plot function that does all at once
plot.cube <- function (x, main, c1, c2, c3, sub, ... ){ #takes a cube object
  c <- c("purple",c1, c2, c3) # will never use purple on loop
  for (i in 2:4){
    ## plot
    ordiplot(x[[1]], type='none', main= paste( main, "vs", sub[i], sep = " "), xlab = NULL, ylab = NULL, cex = 0.8)#,
    #xlim = c(-1.2,1.2), ylim = c(-1,1))
    points(x[[1]]$points, cex=0.7, lwd=0.8,
           col= levelCols[as.vector(fitPAM$clustering)])

    ordihull(x[[1]], groups= as.vector(fitPAM$clustering), label = FALSE, cex=0.2,
             col= levelCols, lty = 0, draw = 'polygon', alpha = 0.25)

    ## Plot environmental fitting
    plot(x[[i]], p.max=0.001, col= c[i], cex=.8)
    # plot(x[[3]], p.max=0.05, col= c2, cex=.5)
    # plot(x[[4]], p.max=0.05, col= c3, cex=.5)
  }
}

# quartz(width = 5, height = 7, pointsize = 8)
par(mfrow = c(4,3), mai = c(0.2,0.2,0.2,0.2))
# Interactions
plot.cube(int.side, main = "Interactions", sub = c( " ","Resource", "Ecological", "Social"),
          c1 = "gray20", # resource
          c2 = "dodgerblue4", # biophysic
          c3 = "darkred") # users
# Resouce
plot.cube(res.side, main = "Resource", sub = c("", "Ecological", "Interactions", "Social"),
          c1 = "dodgerblue4", c2 = "darkgreen", c3 = "darkred")
# biophysic
plot.cube(bio.side, main = "Ecological", sub = c("", "Resource", "Interactions", "Social"),
           c1 = "gray20", c2 = "darkgreen", c3 = "darkred")
# Users
plot.cube(soc.side, main = "Social", sub = c('', "Resource", "Interactions", "Ecological"),
          c1 = "gray20", c2 = "darkgreen", c3 = "dodgerblue4")
```

```{r time, fig.align='center', fig.height = 4, fig.width = 4, error=FALSE, warning=FALSE, message=FALSE, fig.cap = "Do we include it?. The interaction dataset is ordered with non-metric multidimensional scaling for multiple points in time and vectors are fitted for all other variables that significanlty (p < 0.001) explain the variation of the ordination. Each plot title shows the dataset in which the ordination was applied versus the dataset used for the vector fitting. The colors of points and contours correspond to the archetypes found in Fig 1c.", dev.args= list(pointsize = 6) }

mds2 <- list()
for (i in seq_along(c(2005, 2007:2009)) ){  # seq_along(levels(dat$year))
  resp <- crop.dat %>%
    filter (Year == c(2005, 2007:2009)[i]) %>%  #levels(dat$year)
    dplyr::select(TAI_ID1, crop, kcal_crop) %>%
    spread (key = crop, value = kcal_crop) %>%
    dplyr::select(-TAI_ID1)

  mds2[[i]] <- metaMDS(resp, dist = 'manhattan', trymax = 1000)

}

# lapply(mds2, function (x) {x$converged == TRUE})
## Plot them all
# quartz(width=7, height=6, family='Helvetica', pointsize=8)
par(mfcol=c(3,4), mai = c(0.4,0.2,0.2,0.2))
for (i in 1:length(mds2)){
    # cluster with pam
    # mclus.out <- pam(mds2[[i]]$points, metric='manhattan', k=6)

    # NMDS
   ordiplot(mds2[[i]], type='none' , main = c(2005, 2007:2009)[i] , xlab = "Resource", ylab = "")
   points(mds2[[i]]$points, cex=1, lwd=1.5, col= levelCols[as.vector(fitPAM$clustering)])
   ordihull(mds2[[i]], fitPAM$clustering, label = FALSE, cex=0.2,
            col= levelCols, lty = 0, draw = 'polygon', alpha = 0.25)

   # environmental fitting
   ef1 <- envfit(mds2[[i]],resource[-1], permu=999)
   ef2 <- envfit(mds2[[i]], social2[-1], permu=999)
   ef3 <- envfit(mds2[[i]], eco[-1], permu = 999)

   plot(ef1, p.max=0.05, col= "gray20", cex=0.8)

   ordiplot(mds2[[i]], type='none' , xlab = "Social", ylab = "")
   points(mds2[[i]]$points, cex=1, lwd=1.5, col= levelCols[as.vector(fitPAM$clustering)])
   ordihull(mds2[[i]], fitPAM$clustering, label = FALSE, cex=0.2,
            col= levelCols, lty = 0, draw = 'polygon', alpha = 0.25)
   plot(ef2, p.max=0.05, col="darkred", cex=.8)

   ordiplot(mds2[[i]], type='none' , xlab = "Ecological",  ylab = "")
   points(mds2[[i]]$points, cex=1, lwd=1.5, col= levelCols[as.vector(fitPAM$clustering)])
   ordihull(mds2[[i]], fitPAM$clustering, label = FALSE, cex=0.2,
            col= levelCols, lty = 0, draw = 'polygon', alpha = 0.25)
   plot(ef3, p.max = 0.05, col = "dodgerblue4", cex = 0.8)

## J171017: Note that to maintain consistency with colours I don't plot the mclus.out, that is a pam clustering over the new mds for each year analysed. Instead I plot the original aggregated fitting over all years
}

```

## Discussion

> * Add in discussion paper in PNAS with similar case comparison in Mexico (?) {Leslie:2015gr}

The purpose of this paper was outlining a data driven routine for operationalizing Ostrom's SES framework and map SES archetypes. The method relies entirely on open access software [@Brock:2008vz; @Charrad:2014tp], making suitable for replication in other development settings. By applying clustering with a sensitivity analysis routine to the Volta river basin case, we have demonstrated how the method performs in a developing setting with restricted data quality and still renders useful insights. We have found that the Volta basin can be best described by 6 SES archetypes strongly characterized by their crop productivity profiles. Our results also suggest that the implementation of water reservoirs can improve food security in places in the basin historically exposed to high variability in the calories produced per capita.

Our work complements previous efforts for mapping SES in that it considers a broader range of variables both social and ecological outlined by Ostrom. It provides, to our knowledge, a first attempt to upscale Ostrom's framework to a binational scale. Instead of the richness provided by case studies, but constrained by very localized scales, here we have taken advantage of comparing a larger spatial scale at the more detailed level we could find standardized data for: namely the second administrative level for the whole basin. Thus the limits are imposed by data availability. For example, we have not included any variable in the Ostrom SES framework that describes the governance of the system (G). Although governance indicators do exist at national levels (e.g. World Bank database, only available for Ghana), it is not available at the scale of this study and limits our conclusions in that front. Ideal governance variables in our context would be proxies of social capital, how often people share food, what is the structure of the social networks in place, or how efficient are local institutions at managing existing water infrastructure. It suggests that including governance indicators on national monitoring programs such as census or national surveys is an important step forward in data collection. The advantage of the method is that once data of the kind is available for the Volta basin, or for other places where it already exist, it can be easily incorporated on the SES analysis here proposed.

Our work also improves replicability and reproducibility compared to previous efforts of mapping SES [@RaudseppHearne:2010p5327; @Renard:2015ew; @Meacham:2016cy; @Queiroz:2015cv; @Rabe:2016hp; @Hamann:2015cx]. Previous work have relied on only one clustering technique, and heavily used context dependent knowledge to make subjective decisions such as the number of clusters to fit or the clustering technique to apply. It is a valid approach but limits its scalability and reproducibility in that the choices made for one place might not be the most appropriate in other places. Here we have used an updated routine with a sensibility analysis that helps the researcher to make such choices guided by the patterns already contained in the data. While a machine learning approach does not replace the richness of local knowledge, it does facilitates the practical application of the method in absence of field qualitative data (e.g. lack of coverage), or in settings where field work validation is restricted (e.g. war zones). It can complement and guide where qualitative research efforts are to be deployed. The results here presented are limited by the scope of the data and its resolution. For example we can not claim causality statements regarding impacts of water reservoirs on yield or kilocalories produced, to do that one needs extensive time series data and randomized control trials which are beyond the current data availability. However, the patterns here presented can be useful for policy making or identifying priority areas for future investments. Qualitative and quantitative efforts at a refined scale will provide ground validation of our results and hopefully will complement aspects not analyzed here such as governance variables.

## Conclusion

Advancing theories on sustainability science requires articulating existing SES frameworks to generalizable and replicable analysis of large scale systems. Achieving sustainable development goals depends on distinguishing when a sustainable solution is context dependent or when it could be a generalizable pattern that is applicable to different SES arenas. Here we have advance methods to identifying SES by updating clustering routines with a sensitivity analysis that allow us to reinterpret a binational dataset in the Volta basin. We identified where and under which conditions an agricultural innovation such as water infrastructure development is likely to influence the food security of farmers thriving in one of the most arid areas of the world. These patterns although descriptive can inform policy decisions. We believe that identifying patterns of variables in space and time that characterize different social ecological systems is key for further developing theories of sustainability, testing when interventions work, and mapping how nations progress towards sustainable development goals. The methods here outlined are generalizable to other developing settings, and we hope they will help rigourously test under which conditions relationships between the Ostrom's SES framework can have policy relevant implications.

-----------

## Supplementary material

### List of appendixes

To-do list:

> 1. All variables mapped
> 2. Figure with clusters selection?

### Crop data selection
Crop data records available for Ghana and Burkina Faso go as back as `r min(dat$Year)`. Yet, out of the 32 crops recorded, complete data for the basin is only available for 7 crops used in the current analysis. The dataset is far from complete. On its most recent version, the data has `r dim(dat)[1]` observations. An observation is a datapoint of a crop in a district with some production in Tons and some cropped area in Ha. Out of the `r dim(dat)[1]` observations `r sum(is.na(dat$area) | is.na(dat$prod))` are missing values: `NA's` or empty cells on the raw data. This is over 36% of the most complete version of the dataset. For the analysis presented in the paper we only used the 7 most complete crops, and still we had missing values. SM Fig1 shows the missing values in orange, the darker the blue the better, meaning data is complete for the 99 spatial units analyzed. The only crops for which we have data for both countries are `r intersect(dat$crop[dat$country == 'GH'], dat$crop[dat$country =='BF'])`. All data was log-transformed, total crop area calculated as well as the proportion of cultivated area per crop. However area values were not used for the analysis due to high correlations with production data. Production in Tons was transformed to Kcals with data from FAO. And the mean for a 7 year period (skipping 2006) will be used for the interaction dataset in the clustering analysis. The data for key 7 crops has 4851 observations of which 4664 does not contain missing values. Now instead of >30%, missing values were reduced to 3.85%. Mean values and log-transformations were performed for each district or province droping the missing values, meaning that for some provices and some crops the mean is not based on 7 values but less (>4 in minimum cases). In doing so we avoid zero inflation on the distributions of the original data that can bias the clustering results.


```{r SMFig1, fig.height = 3, fig.width = 3, fig.cap = 'SMFig1. Crop selection. ', dev.args = list(pointsize = 5)}

## Missing values
missing <- as.data.frame(with(filter(dat, !is.na(area), !is.na(prod)), table(Year, crop)))
g <- ggplot(missing, aes(Year, crop)) + geom_raster(aes(fill = Freq)) + theme_minimal(base_size = 5)
g + scale_fill_gradient(low = "#FFA50080", high = "#0000FF80")  + theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```


```{r SM_Fig2, fig.align='center', fig.height=3, fig.width=8, error=FALSE, warning=FALSE, message=FALSE, fig.cap = 'SMFig2. Clustering results with 9 clusters. Social-Ecological systems archetypes found by applying different clustering techniques. Upper panel shows non-metric multi dimensional scaling of the data and maps for 9 clusters, and the lower panel the respective maps. Best performing algorithms are hierarchical clustering (e), partition around medioids (c), and clara (a).', dev.args= list(pointsize = 7)}


########################
### Clustering all
########################
library(kohonen)
#quartz(width=8, height= 3, pointsize = 7)
# number of clusters
k <- 9

par(mfrow=c(2,6))

for (i in 1:length(k)){
  par(mai = c(0.2, 0.2, 0.2 , 0.2))

  ## Best selected algorithms: hierarchical, k-means and som
  fitKM <- kmeans(df[-c(1,2)], centers= k[i] ,iter.max=2000,nstart=50)
  fitSOM <- som(as.matrix(df[-c(1,2)]), grid= somgrid(3,2,'hexagonal'))
  fitPAM <-pam(mds$points, metric='manhattan', k=k[i])
  dis <- vegdist(df[-c(1,2)], method='manhattan')
  clus <- hclust(dis, method='ward.D2')
  grp <- cutree(clus, k[i])
  fitHier <- grp
  fitClara <- clara(df[-c(1,2)], k = k[i])

  # create a clusters dataframe
  clusters <- data.frame(TAI_ID1 = df$TAI_ID1, # codes
                         Clara = as.vector(fitClara$clustering ),
                         k_means = as.vector(fitKM$cluster),
                         PAM = as.vector(fitPAM$clustering),
                         SOM = as.vector(fitSOM$unit.classif),
                         Hierarchical = as.vector(fitHier),
                         Ward = clust_num$Best.partition
  )

  # create colors
  levelCols <- brewer.pal(k [i], "Set3")

  # plot
  for (j in 2:7){
    # Plot MDS with grouping according with each clustering algorithm
    ordiplot(mds, type='none', main= paste(letters[j-1], colnames( clusters)[j],  sep = '.) '), xlab = NULL, ylab = NULL )
    points(mds$points, cex=1, lwd=1.5,
           col= levelCols[clusters[,j]]) #volta.shp@data[,i]
    ordihull(mds, groups= clusters[,j], label = TRUE, cex=0.7,
             col="purple", lty=1)
    #plot(ef1, p.max=0.05, col='blue', cex=0.5)
    #plot(ef2, p.max=0.05, col='purple', cex=0.5)
  }


  for (j in 2:7){
    par(mai = c(0.2, 0.2, 0.2 , 0.2))
    # Plot map with resulting clusters
    plot(volta.shp, col= levelCols[clusters[,j]],lwd=0.1)
    # main= paste(k[i], colnames( clusters)[j], sep = ' '))

  }
}

# plot(volta.shp, col = levelCols[clust_num_mb$Best.partition], lwd = 0.1)
# setwd("~/Documents/Projects/TAI/figures")
# quartz.save(file = '161125_full_clustering.png', type = 'png', dpi = 300,width=15, height=5, pointsize = 7 )

```

```{r SM_Fig3, echo = FALSE, fig.align='center', fig.height = 4, fig.width = 4 , error=FALSE, warning=FALSE, message=FALSE, fig.cap = "SMFig3. Correlogram for full dataset", dev.args= list(pointsize = 5)  }
library (corrgram)
corrgram(df, upper.panel = 'panel.pts', lower.panel = "panel.cor" )

# GGally::ggscatmat(df, columns = 3:length(df)) + theme_grey(base_size = 6)
```


## Outline
The manuscript is written with the PNAS audience in mind (max ~3500 words). It should focus on the method development, how it is useful on the context of poverty alleviation and food security, and how it can be applied to other developing contexts. Roughly:

* Abstract 200w
* Intro and problem setting 1000w
    + SDG's: how do we target, measure and monitor progress in developing context?
    + volta river basing as case study
* Method 500w (it's a methods paper so it should have a methods section, but technical details should go at the end)
    + In a nutshell it's a clustering problem: how others have done it
    + Space and time
* Results 500w
    + Figure 1. Clustering all: an schema of the SES framework + clusters based on full data
    + Figure 2. the cube
    + Figure 3. Interactions vs others * 12 = the movie -> change of archetype over time?
* Discussion 1000w
* Conclusion 300w
* Methods
    + Data
    + Clustering & mapping
    + Temporal trends
* Refs 30max


-------


# References
